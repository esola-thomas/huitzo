---
export interface Props {
  code: string;
  lang?: string;
  filename?: string;
  highlight?: number[];
  class?: string;
}

const { code, lang = 'text', filename, highlight = [], class: className = '' } = Astro.props;

// Generate a unique ID for this code block
const blockId = `code-${Math.random().toString(36).substr(2, 9)}`;
---

<div class={`code-block ${className}`}>
  {/* Header with language and filename */}
  <div class="code-block-header">
    <div class="code-block-info">
      {lang && <span class="code-lang">{lang}</span>}
      {filename && <span class="code-filename">{filename}</span>}
    </div>
    <button
      class="copy-button"
      data-code-id={blockId}
      aria-label="Copy code"
      title="Copy code"
    >
      <svg class="copy-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
      <svg class="check-icon hidden" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      <span class="copy-text">Copy</span>
    </button>
  </div>

  {/* Code content */}
  <div class="code-block-content">
    <pre id={blockId} class="code-pre"><code class={`language-${lang}`}>{code.trim()}</code></pre>
  </div>
</div>

<style>
  .code-block {
    background: var(--aw-color-bg-tertiary);
    border: 1px solid var(--aw-color-border);
    border-radius: 8px;
    overflow: hidden;
    margin: 1.5rem 0;
  }

  .code-block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-bottom: 1px solid var(--aw-color-border);
  }

  .code-block-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .code-lang {
    font-family: var(--aw-font-mono);
    font-size: 0.75rem;
    color: var(--aw-color-primary);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
  }

  .code-filename {
    font-family: var(--aw-font-mono);
    font-size: 0.75rem;
    color: var(--aw-color-text-muted);
  }

  .copy-button {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: transparent;
    border: 1px solid var(--aw-color-border);
    border-radius: 4px;
    color: var(--aw-color-text-muted);
    font-family: var(--aw-font-mono);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .copy-button:hover {
    background: var(--aw-color-primary);
    border-color: var(--aw-color-primary);
    color: var(--aw-color-bg-page);
  }

  .copy-button.copied {
    background: var(--aw-color-success);
    border-color: var(--aw-color-success);
    color: var(--aw-color-bg-page);
  }

  .copy-icon,
  .check-icon {
    flex-shrink: 0;
  }

  .hidden {
    display: none;
  }

  .code-block-content {
    padding: 1.5rem;
    overflow-x: auto;
  }

  .code-pre {
    margin: 0;
    padding: 0;
    background: transparent;
    border: none;
    font-family: var(--aw-font-mono);
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--aw-color-text-default);
  }

  .code-pre code {
    background: transparent;
    padding: 0;
    color: inherit;
  }

  /* Mobile: smaller text */
  @media (max-width: 640px) {
    .code-pre {
      font-size: 0.75rem;
    }

    .copy-text {
      display: none;
    }
  }

  /* Scrollbar */
  .code-block-content::-webkit-scrollbar {
    height: 8px;
  }

  .code-block-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
  }

  .code-block-content::-webkit-scrollbar-thumb {
    background: var(--aw-color-border);
    border-radius: 4px;
  }

  .code-block-content::-webkit-scrollbar-thumb:hover {
    background: var(--aw-color-primary);
  }
</style>

<script>
  // Copy code functionality
  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.copy-button');

    copyButtons.forEach((button) => {
      button.addEventListener('click', async () => {
        const codeId = button.getAttribute('data-code-id');
        const codeBlock = document.getElementById(codeId as string);

        if (!codeBlock) return;

        const code = codeBlock.textContent || '';
        const copyIcon = button.querySelector('.copy-icon');
        const checkIcon = button.querySelector('.check-icon');
        const copyText = button.querySelector('.copy-text');

        try {
          await navigator.clipboard.writeText(code);

          // Visual feedback
          button.classList.add('copied');
          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');
          if (copyText) copyText.textContent = 'Copied!';

          // Reset after 2 seconds
          setTimeout(() => {
            button.classList.remove('copied');
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
            if (copyText) copyText.textContent = 'Copy';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });
    });
  });
</script>
