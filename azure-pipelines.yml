# Azure Pipeline to sync Azure DevOps repository to GitHub
# This pipeline runs when changes are pushed to the main branch in Azure DevOps
# It syncs the changes to GitHub, which then triggers GitHub Pages deployment

trigger:
  branches:
    include:
      - main
      - master

# No PR triggers - we only want to sync on direct pushes to main
pr: none

pool:
  name: 'Default'

variables:
  # Reference the variable group from Azure DevOps Library
  - group: 'GitHub Public repo sync'
  # Additional variables
  - name: GITHUB_REPO_URL
    value: 'https://github.com/esola-thomas/huitzo'
  - name: GITHUB_USERNAME
    value: 'esola-thomas'

stages:
- stage: SyncToGitHub
  displayName: 'Sync to GitHub Repository'
  jobs:
  - job: GitHubSync
    displayName: 'Sync Repository to GitHub'
    steps:

    # Checkout the source code from Azure DevOps
    - checkout: self
      persistCredentials: true
      clean: true
      fetchDepth: 0  # Full clone for proper git history

    # Clean up workspace and ensure clean state
    - script: |
        echo "Cleaning up workspace..."
        # Clean any untracked files and directories
        git clean -fdx || true
        # Reset any local changes
        git reset --hard HEAD || true
        # Delete any local branches except main/master
        git branch | grep -v "main\|master" | xargs -r git branch -D || true
        echo "Workspace cleaned"
      displayName: 'Clean Workspace'

    # Configure Git user for the sync
    - script: |
        git config --global user.name "Azure DevOps Pipeline"
        git config --global user.email "pipeline@azuredevops.com"
      displayName: 'Configure Git User'

    # Add GitHub as a remote repository
    - script: |
        git remote add github https://$(GITHUB_PERSONAL_ACCESS_TOKEN)@github.com/$(GITHUB_USERNAME)/huitzo.git
        git remote -v
      displayName: 'Add GitHub Remote'

    # Fetch GitHub main branch to compare
    - script: |
        echo "Fetching GitHub main branch..."
        git fetch github main:github-main 2>/dev/null || echo "GitHub main branch doesn't exist yet"
      displayName: 'Fetch GitHub Branch'

    # Create new commit with custom message and sync to GitHub
    - script: |
        echo "Current branch: $(git branch --show-current)"
        echo "Fetching latest from origin..."
        git fetch origin

        echo "Checking out main branch..."
        git checkout main || git checkout -b main

        # Get the latest commit info from Azure DevOps
        AZURE_COMMIT_HASH=$(git rev-parse HEAD)
        AZURE_COMMIT_MSG=$(git log -1 --pretty=format:"%s")
        AZURE_AUTHOR=$(git log -1 --pretty=format:"%an")

        echo "Latest Azure DevOps commit: $AZURE_COMMIT_HASH"
        echo "Original commit message: $AZURE_COMMIT_MSG"
        echo "Original author: $AZURE_AUTHOR"

        # Clean up any existing sync-branch
        echo "Cleaning up any existing sync-branch..."
        git branch -D sync-branch 2>/dev/null || echo "No existing sync-branch to delete"

        # Check if GitHub repo exists and has commits
        if git show-ref --verify --quiet refs/remotes/github/main; then
          echo "GitHub main branch exists, checking for differences..."
          GITHUB_COMMIT_HASH=$(git rev-parse github/main)

          # Check if the commits are different
          if [ "$AZURE_COMMIT_HASH" = "$GITHUB_COMMIT_HASH" ]; then
            echo "No changes to sync - commits are identical"
            exit 0
          fi

          echo "Changes detected, creating sync branch from GitHub main..."
          # Create a new branch from GitHub main
          git checkout -b sync-branch github/main
        else
          echo "GitHub main branch doesn't exist, creating new branch..."
          git checkout -b sync-branch origin/main
        fi

        echo "Syncing latest changes from Azure DevOps origin/main..."

        # Instead of resetting, merge or cherry-pick the new commits
        # Get all commits from GitHub main to Azure DevOps main
        COMMITS_TO_SYNC=$(git rev-list github/main..origin/main --reverse)

        if [ -z "$COMMITS_TO_SYNC" ]; then
          echo "No new commits to sync"
          exit 0
        fi

        echo "Commits to sync:"
        git log --oneline github/main..origin/main

        # Create custom sync commit messages with timestamp prefix
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

        # Cherry-pick each commit with modified message
        for commit in $COMMITS_TO_SYNC; do
          ORIGINAL_MSG=$(git log -1 --pretty=format:"%s" $commit)
          ORIGINAL_AUTHOR=$(git log -1 --pretty=format:"%an <%ae>" $commit)
          SYNC_MSG="sync_${TIMESTAMP}: ${ORIGINAL_MSG}"

          echo "Cherry-picking commit $commit with message: $SYNC_MSG"

          # Cherry-pick the commit but don't commit yet
          if git cherry-pick --no-commit $commit; then
            # Create a new commit with sync message
            git commit -m "$SYNC_MSG" --author="$ORIGINAL_AUTHOR"
          else
            echo "Merge conflict during cherry-pick, resolving automatically..."
            # Add all files (resolving conflicts by taking Azure DevOps version)
            git add .
            git commit -m "$SYNC_MSG" --author="$ORIGINAL_AUTHOR"
          fi
        done

        echo "Pushing to GitHub main branch..."

        # Try normal push first (preserves history)
        if git push https://$(GITHUB_PERSONAL_ACCESS_TOKEN)@github.com/$(GITHUB_USERNAME)/huitzo.git sync-branch:main; then
          echo "✅ Normal push successful! History preserved."
        elif git push https://$(GITHUB_PERSONAL_ACCESS_TOKEN)@github.com/$(GITHUB_USERNAME)/huitzo.git sync-branch:main --force-with-lease; then
          echo "✅ Force-with-lease push successful!"
        else
          echo "❌ Push failed. This might indicate branch protection or authentication issues."
          echo "Checking if we need to bypass branch protection..."

          # Last resort - force push (only when necessary)
          if git push https://$(GITHUB_PERSONAL_ACCESS_TOKEN)@github.com/$(GITHUB_USERNAME)/huitzo.git sync-branch:main --force; then
            echo "⚠️ Force push successful, but GitHub history was overwritten."
          else
            echo "❌ All push methods failed. Check GitHub token permissions and branch protection."
            exit 1
          fi
        fi

        # Clean up the sync-branch after successful push
        git checkout main
        git branch -D sync-branch
        echo "✅ Sync completed successfully!"
      displayName: 'Sync to GitHub with Custom Commit'

    # Optional: Create a GitHub release tag for major updates
    - script: |
        if [ "$(Build.SourceBranch)" = "refs/heads/main" ] && [ "$(CREATE_GITHUB_RELEASE)" = "true" ]; then
          TAG_NAME="v$(date +%Y.%m.%d)-build$(Build.BuildNumber)"
          echo "Creating GitHub release tag: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Automated release from Azure DevOps - Build $(Build.BuildNumber)"
          git push github "$TAG_NAME"
        else
          echo "Skipping GitHub release creation"
        fi
      displayName: 'Create GitHub Release (Optional)'
      condition: and(succeeded(), eq(variables['CREATE_GITHUB_RELEASE'], 'true'))

# Optional: Notification stage to confirm sync
- stage: Notification
  displayName: 'Sync Notification'
  dependsOn: SyncToGitHub
  condition: always()
  jobs:
  - job: NotifySync
    displayName: 'Notify Sync Status'
    steps:
    - script: |
        if [ "$(Agent.JobStatus)" = "Succeeded" ]; then
          echo "✅ Successfully synced to GitHub!"
          echo "GitHub Pages deployment should start automatically."
          echo "Check: https://github.com/$(GITHUB_USERNAME)/huitzo/actions"
        else
          echo "❌ GitHub sync failed. Please check the logs."
        fi
      displayName: 'Sync Status'